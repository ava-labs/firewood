name: ci

on:
  pull_request:
  push:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      matrix:
        include:
          - profile-key: debug-no-features
            profile-args: ""
          - profile-key: debug-ethhash
            profile-args: "--features ethhash"
          - profile-key: debug-ethhash-logger
            profile-args: "--features ethhash,logger"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ matrix.profile-key }}
      - name: Check
        run: cargo check ${{ matrix.profile-args }} --workspace --tests --examples --benches
      - name: Build
        run: cargo build ${{ matrix.profile-args }} --workspace --tests --examples --benches


  no-rust-cache-lint:
    runs-on: ubuntu-latest

    steps:
      - name: Check license headers
        uses: viperproject/check-license-header@v2
        with:
          path: .
          config: .github/check-license-headers.yaml
          strict: true
      - name: Format
        run: cargo fmt -- --check

  rust-lint:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - profile-key: debug-no-features
            profile-args: ""
          - profile-key: debug-ethhash-logger
            profile-args: "--features ethhash,logger"

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: "false"
          shared-key: ${{ matrix.profile-key }}
      - name: Clippy
        run: cargo clippy ${{ matrix.profile-args }} --tests --examples --benches -- -D warnings

  test:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - profile-key: debug-no-features
            profile-args: ""
          - profile-key: debug-ethhash
            profile-args: "--features ethhash"
          - profile-key: debug-ethhash-logger
            profile-args: "--features ethhash,logger"
          # TODO: enable testing with branch_factor_256
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: "false"
          shared-key: ${{ matrix.profile-key }}
      - name: Run tests with features enabled
        run: cargo test --verbose ${{ matrix.profile-args }}

  examples:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - profile-key: debug-no-features
            profile-args: ""
          - profile-key: debug-ethhash
            profile-args: "--features ethhash"
          - profile-key: debug-ethhash-logger
            profile-args: "--features ethhash,logger"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: "false"
          shared-key: ${{ matrix.profile-key}}
      - name: Run benchmark example
        run: RUST_BACKTRACE=1 cargo run ${{ matrix.profile-args }} --release --bin benchmark -- --number-of-batches 100 --batch-size 1000 create
      - name: Run insert example
        run: RUST_BACKTRACE=1 cargo run ${{ matrix.profile-args }} --release --example insert

  docs:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: "false"
          shared-key: "debug-no-features"
      - run: RUSTDOCFLAGS="-D warnings" cargo doc --document-private-items --no-deps

  ffi:
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: "false"
          shared-key: "debug-no-features"
      - name: Build Firewood FFI
        working-directory: ffi
        run: cargo build --release
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "ffi/go.mod"
          cache-dependency-path: "ffi/go.sum"
      - name: Run golanci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          working-directory: ffi
      - name: Test Go FFI bindings
        working-directory: ffi
        # cgocheck2 is expensive but provides complete pointer checks
        run: GOEXPERIMENT=cgocheck2 TEST_FIREWOOD_HASH_MODE=firewood go test ./...
      
  ethhash-compatibility-go:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: "false"
          shared-key: "debug-ethhash"
      - name: Build Firewood FFI (with ethhash)
        run: cargo build --release --features ethhash
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "ffi/tests/go.mod"
          cache-dependency-path: "ffi/tests/go.sum"
      - name: Test Go FFI bindings
        working-directory: ffi
        # cgocheck2 is expensive but provides complete pointer checks
        run: GOEXPERIMENT=cgocheck2 TEST_FIREWOOD_HASH_MODE=ethhash go test ./...
      - name: Test Ethereum hash compatability
        working-directory: ffi/tests
        run: go test ./...
