name: ci

on:
  workflow_dispatch:  # Manual trigger for testing
  pull_request:
  push:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: full

jobs:
  # =============================================================================
  # Shell Error Handling Verification
  # =============================================================================
  # Purpose: Test if the script fails when gh returns non-zero, without the
  # defensive `if ! gh workflow run` check.
  #
  # Context: We observed `gh workflow run` printing HTTP 422 but the script
  # continuing despite `set -euo pipefail`. This test runs the actual script
  # with the defensive check removed to see if set -e catches the error.
  # =============================================================================
  shell-error-handling:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Show gh version and shell options
        run: |
          echo "==> gh version:"
          gh --version
          echo ""
          echo "==> Shell options:"
          set -o | grep -E "errexit|pipefail"

      - name: Test script without defensive check (expect failure)
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.FIREWOOD_AVALANCHEGO_GITHUB_TOKEN }}
          TEST: "firewood-101-250k"
          AVALANCHEGO_REF: "2f6b55f384af4e313ae4b2aa8a15f161552e2222"
          RUNNER: "avago-runner-i4i-2xlarge-local-ssd"
        run: |
          echo "==> Running script with bad AVALANCHEGO_REF (commit SHA)..."
          echo "    AVALANCHEGO_REF=$AVALANCHEGO_REF"
          echo "    This should trigger HTTP 422 and fail the step."
          echo ""
          echo "    If this step FAILS: set -e caught the gh error âœ“"
          echo "    If this step PASSES: script continued despite error (mystery!)"
          echo ""
          
          ./scripts/bench-cchain-reexecution.sh trigger
          
          echo ""
          echo "::warning::Script completed without failing - the mystery is real!"

  # =============================================================================
  # Original jobs commented out for focused testing
  # Uncomment everything below this line to restore normal CI
  # =============================================================================
